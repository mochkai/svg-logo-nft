import { util } from "chai";
import { mkdirSync, readFileSync, rmdirSync, writeFileSync } from "fs";
import random from "random";
var pathParse = require('path-parse');

class AutoGen {
  private quantity: number;
  private configuration: any;
  private name: string = "SVG Logo";
  private description: string = "This logo has been autogenerated by Mochkai's script. If you would like to see it live chack it out on twitch!! https://www.twitch.tv/mochkai";
  private attributes: any = null;
  private metadata: any = null;
  private baseSVG: string = '';
  private outPath: string = '';
  private debug: boolean = false;

  constructor(_quantity: number, _configPath?: string) {
    if (!_quantity && _quantity > 0) throw 'Quantity is required';

    this.quantity = _quantity;

    let configPath = _configPath || __dirname + "/config.json";

    let configFile: any = false;

    if (!this.debug) process.stdout.write("Initialiing...");

    try {
      this.configuration = JSON.parse(readFileSync(configPath, 'utf-8'));
    }
    catch (error) {
      this.debugLog(error);

      let _config: any = {};

      for (let i = 1; i < 5; i++) {
        _config['property' + i] = [];
        for (let j = 1; j < 10; j++) {
          _config['property' + i].push({
            value: 'value' + j,
            weight: j * 10
          });
        }
      }

      this.configuration = _config;

      writeFileSync(configPath, JSON.stringify(this.configuration));

      throw 'No config file found... A new file was created at ./config.json';
    }

    if (!this.configuration) throw 'No config file Found';

    this.setGeneratedFilesLocation();

    rmdirSync(this.outPath, { recursive: true });

    if (!this.debug) process.stdout.write("Success!\n");
  }

  public generateMetadataAttributes() {
    let attributes = [];

    if (!this.debug) process.stdout.write("Generating Attributes... 0%");

    for (let item = 0; item < this.quantity; item++) {

      let _attributes = [];
      for (let property in this.configuration) {
        let curWeight = 0;
        let randomValue = random.float() * 100;
        let config = this.configuration[property];
        let configItem = config.find((p: any) => {
          curWeight += p.weight;

          if (curWeight - randomValue >= 0)
            return p;
        });

        _attributes.push({
          trait_type: property,
          value: configItem.value
        });
      }

      let tempAttr = JSON.stringify(_attributes);

      //Check for duplicate and restart process if found
      if (attributes.indexOf(tempAttr) == -1) {
        attributes[item] = tempAttr;
        if (!this.debug) {
          process.stdout.write("\r\x1b[K");
          process.stdout.write("Generating Attributes... " + ((attributes.length / this.quantity) * 100).toFixed(2) + "%");
        }
      } else {
        item--;
        this.debugLog("Duplicate Item found at ", attributes.indexOf(attributes[item]));
      }
    }

    if (!this.debug) process.stdout.write("\n");

    this.attributes = attributes;
  }

  public generateMetadata() {
    let metadata: any = [];

    if (!this.debug) process.stdout.write("Generating Metadata with SVGs... 0%");

    for (let item = 0; item < this.quantity; item++) {
      metadata[item] = {
        name: this.name + " #" + (item + 1),
        description: this.description,
        attributes: JSON.parse(this.attributes ? this.attributes[item] : false),
      };

      if (metadata[item].attributes)
        this.generateSVG(metadata[item].attributes, "logo#" + (item + 1).toString().padStart(this.quantity.toString().length, "0"));

      if (!this.debug) {
        process.stdout.write("\r\x1b[K");
        process.stdout.write("Generating Metadata with SVGs... " + ((metadata.length / this.quantity) * 100).toFixed(2) + "%");
      }
    }

    this.metadata = metadata;

    if (!this.debug) process.stdout.write("\n");

    this.debugLog(util.inspect(this.metadata, false, 10));
  }

  public generateSVG(_attributes: any, fileName: string) {
    let genSVG = this.baseSVG;

    for (let attr in _attributes) {
      this.debugLog(attr, _attributes[attr]);
      let property = this.camelCase(_attributes[attr].trait_type);

      this.debugLog(property);

      genSVG = genSVG.replace("{{" + property + "}}", _attributes[attr].value);
    }

    this.debugLog(genSVG);

    try {
      mkdirSync(this.outPath, { recursive: true });
      writeFileSync(this.outPath + fileName + ".svg", genSVG);
    } catch (error) {
      this.debugLog(error);
      throw 'Error Generating the SVG';
    }
  }

  public setGeneratedFilesLocation(_path?: string) {
    if (_path)
      this.outPath = _path;
    else
      this.outPath = 'assets/gen/';
  }

  public setBaseSVG(_path: string) {
    try {
      this.baseSVG = readFileSync(_path).toString();
      this.debugLog(this.baseSVG);
    } catch (error) {
      this.debugLog(error);
      throw 'Could not find and SVG image at : ' + _path + '\nnote: make sure the path is relative to the root or absolute to the system.';
    }
  }

  private camelCase(_string: string) {
    return _string.charAt(0).toLowerCase() + _string.slice(1).replace(" ", "");
  }

  private debugLog(...messages: any) {
    if (this.debug) console.log(...messages);
  }
}

export { AutoGen };